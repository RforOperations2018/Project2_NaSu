---
title: "Project2"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: fill
    theme: yeti
    favicon: favicon.ico
---
```{r}
library(flexdashboard)
library(shiny)
library(reshape2)
library(plotly)
library(shinythemes)
library(ggplot2)
library(plyr)
library(httr)
library(jsonlite)
library(dplyr)
require(rgdal)
require(leaflet)
require(leaflet.extras)
require(readxl)
require(stringr)
options(scipen = 4)
```

```{r setup, include=FALSE}
ckanSQL <- function(url) {
  # Clean the URL
  url <- gsub(" ", "%20", url)
  # Print URL for debugging
  print(url)
  # Make the Request
  r <- GET(url)
  # Extract Content
  c <- content(r, "text")
  # Basic gsub to make NA's consistent with R
  json <- gsub('NaN', 'NA', c, perl = TRUE)
  # Create Dataframe
  data.frame(jsonlite::fromJSON(json)$result$records)
}
ckanUniques <- function(id, field) {
  url <- paste0("https://data.wprdc.org/api/action/datastore_search_sql?sql=SELECT%20DISTINCT(%22", field, "%22)%20from%20%22", id, "%22")
  c(ckanSQL(url))
}

# Get distinct choices for input select
TYPE_Choice <- sort(ckanUniques("e500cd8b-aa04-4845-a77f-c93b6dfa86b0", "TYPE")$TYPE)
DAM_HEIGHT_Choice <- sort(ckanUniques("e500cd8b-aa04-4845-a77f-c93b6dfa86b0", "DAM_HEIGHT")$DAM_HEIGHT)
DAM_HEIGHT_Choice <- as.numeric(DAM_HEIGHT_Choice)
DAM_NAME_Choice <- sort(ckanUniques("e500cd8b-aa04-4845-a77f-c93b6dfa86b0", "DAM_NAME")$DAM_NAME)

damInput <- reactive({
  # Building an IN selector
  TYPE_filter <- ifelse(length(input$TYPESelect) > 0, 
                          paste0("%20%22TYPE%22%20IN%20(%27", paste(input$TYPESelect, collapse = "%27,%27"),"%27)"),"")
  DAM_HEIGHT_filter <- ifelse(length(input$DAM_HEIGHTSelect) > 0,
                            paste0("%20AND%20%22DAM_HEIGHT%22%20BETWEEN%20%27", paste(input$DAM_HEIGHTSelect, collapse = "%27AND%27"),"%27"),"")
  ff <- input$DAM_NAMESelect
  ff <- gsub("'", "''", ff)
  ff <- gsub("#", "%23", ff)
  DAM_NAME_filter <- ifelse(length(ff) > 0,
                          paste0("%20AND%20%22DAM_NAME%22%20IN%20(%27", paste(ff, collapse = "%27,%27"),"%27)"),"")
  # Build API Query with proper encodes
  url <- paste0("https://data.wprdc.org/api/action/datastore_search_sql?sql=SELECT%20*%20FROM%20%22e500cd8b-aa04-4845-a77f-c93b6dfa86b0%22%20WHERE",
                TYPE_filter,
                DAM_HEIGHT_filter,DAM_NAME_filter)
  # 
   # Load and clean data
  print(url)
  data_get <-  ckanSQL(url) %>%
    mutate(X = as.numeric(X),
           Y = as.numeric(Y),
           DAM_HEIGHT = as.numeric(DAM_HEIGHT),
           TYPE = mapvalues(TYPE,c(""),c("UNKNOWN")))
  return(data_get) 
    
})


Hydrology_Areas.load <- readOGR(dsn = path.expand("C:/Users/sunas/Desktop/Courses/R shiny/Project2_NaSu/Allegheny_County_Hydrology_Areas"), layer = "Allegheny_County_Hydrology_Areas")


areas_Input <- reactive({
  Hydrology_Areas <- Hydrology_Areas.load
  if (length(input$FEATURECODSelect) > 0) {
    Hydrology_Areas <- subset(Hydrology_Areas, FEATURECOD %in% input$FEATURECODSelect)
  }
  return(Hydrology_Areas) 
})


```

Graphs
=====================================

Sidebar {.sidebar}
-------------------------------------

```{r}
# checkbox Selection
checkboxGroupInput("TYPESelect",
                   "Type:",
                   # label = c("EARTH" = "EARTH", "GRAVITY" = "GRAVITY","OTHER" = "OTHER","" = "UNKNOWN"),
                   choices = TYPE_Choice,
                   selected = c("EARTH", "GRAVITY"))
# Selectinput Selection
selectInput("DAM_NAMESelect",
            "Dam:",
            choices = DAM_NAME_Choice,
            multiple = TRUE,
            selectize = TRUE,
            selected = c("PINE CREEK","UPPER DAM","GLADE LAKE","BALD KNOB","LaROCHE COLLEGE DETENTION BASIN"))
#Siderbar Selection
sliderInput("DAM_HEIGHTSelect",
            "Dam Height:",
            min = min(DAM_HEIGHT_Choice, na.rm = T),
            max = max(DAM_HEIGHT_Choice, na.rm = T),
            value = c(min(DAM_HEIGHT_Choice, na.rm = T), max(DAM_HEIGHT_Choice, na.rm = T)), step = 1)
```

Row {.tabset .tabset-fade}
-------------------------------------


```{r}
renderPlotly({
  data_dam <- damInput()
  ggplotly(
    ggplot(data= data_dam, aes(x = TYPE, fill = DAM_NAME)) +
      geom_bar() + theme(axis.title.x=element_blank(),
                               axis.text.x=element_blank(),
                               axis.ticks.x=element_blank()) +
      ggtitle("Distrubution of Award Requested by Grant Type") +
      xlab("Applicant") +
      ylab("Award Requested"))
})
```

```{r}
renderPlotly({
  data_dam <- damInput()
  ggplotly(
    ggplot(data= data_dam, aes(x = DAM_NAME, y = DAM_HEIGHT)) +
      geom_point() + theme(axis.title.x=element_blank(),
                               axis.text.x=element_blank(),
                               axis.ticks.x=element_blank()) +
      ggtitle("Distrubution of Award Requested by Grant Type") +
      xlab("Applicant") +
      ylab("Award Requested"))
})
```

Map
=====================================
Sidebar {.sidebar}
-------------------------------------
```{r}
# checkbox Selection
checkboxGroupInput("FEATURECODSelect",
                   "Feature code:",
                   choices = unique(Hydrology_Areas.load$FEATURECOD),
                   selected = c("410", "420"))
```

Row {.tabset .tabset-fade}
-------------------------------------

```{r}
pal311 <- colorFactor(c("#386cb0","#f0027f","#bf5b17","#666666"), c("EARTH", "GRAVITY","OTHER","UNKNOWN"))
pal23 <- colorFactor(c("#800026","#fc4e2a","#33a02c","#b15928","#ff7f00","#6a3d9a","#ffed6f","#253494"),c("0","410", "420", "430", "450","460", "470", "520"))
renderLeaflet({
  data_dam <- damInput()
  Hydrology_Areas <- areas_Input()
  leaflet() %>%
    addProviderTiles("OpenStreetMap.HOT") %>%
    addPolygons(data = Hydrology_Areas, color = ~pal23(FEATURECOD))%>%
    addLegend(data = Hydrology_Areas,position = "bottomright", pal = pal23, values = ~FEATURECOD)%>%
    addCircleMarkers(data = data_dam, lng = ~X, lat = ~Y, radius = 5, color = ~pal311(data_dam$TYPE)) %>%
    addLegend(data = data_dam, position = "topright" , pal = pal311, values = data_dam$TYPE, title = "TYPE")
})

```



Table
=====================================

Row 
-------------------------------------
### Table 

```{r}
DT::renderDataTable({
  data_dam <- damInput()
  subset(data_dam, select = c(X, Y, DAM_NAME, TYPE,DAM_HEIGHT,DRAIN_AREA))
})

downloadHandler(
  filename = function() {
    paste("City Wide Revenues and Expenses", Sys.Date(), ".csv", sep="")
    },
  content = function(file) {
    write.csv(damInput(), file)
    })

downloadButton("data","Download City Wide Revenues and Expenses Data")

```



